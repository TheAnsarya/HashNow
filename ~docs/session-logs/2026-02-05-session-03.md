# Session Log - 2026-02-05 Session 03

## Summary

Fixed another critical bug in HashNow where the application failed silently after UAC elevation. When users clicked "Yes" on the admin privilege prompt, the elevated process would start but do nothing. Released v1.3.4 with the fix.

## Problem

User reported: "It did not install or even ask me to install. It ask for admin privileges then didn't do anything."

### User Flow (Broken in v1.3.3)

1. Double-click HashNow.exe
2. App detects not admin, prompts: "Administrator privileges required. Restart as Administrator?"
3. User clicks "Yes"
4. UAC prompt appears
5. User clicks "Yes" on UAC
6. Elevated process starts
7. **Nothing happens** - no installation, no success dialog, just exits silently

## Root Cause Analysis

### The Problem

When `RestartAsAdmin()` elevated the process, it restarted HashNow.exe **without any arguments**:

```csharp
// BROKEN CODE (v1.3.3)
var startInfo = new ProcessStartInfo {
	FileName = exePath,
	// ❌ NO ARGUMENTS!
	UseShellExecute = true,
	Verb = "runas"
};
```

When the elevated process started:

1. `args.Length == 0` → calls `HandleNoArguments()`
2. `DetectDoubleClickLaunch()` runs detection logic
3. Parent process is the **previous non-elevated HashNow.exe**, not `explorer.exe`
4. Detection logic returns `false` (thinks it's CLI mode)
5. Tries to use console methods
6. WinExe has no console → silent failure

OR:

1. Detection returns `true` (GUI mode)
2. Checks if installed: yes (previous version installed)
3. Shows "already installed" message and exits
4. **Doesn't actually update the installation**

Either way, the installation never proceeds.

## Solution

Added a `--gui-install` argument to tell the elevated process to proceed with installation:

### Code Changes

**1. Added `--gui-install` handler in Main()**

```csharp
// GUI install command (used when restarting as admin from double-click)
if (firstArg.Equals("--gui-install", StringComparison.OrdinalIgnoreCase)) {
	return InstallContextMenuGui();
}
```

**2. Modified RestartAsAdmin() to pass the argument**

```csharp
// FIXED CODE (v1.3.4)
var startInfo = new ProcessStartInfo {
	FileName = exePath,
	Arguments = "--gui-install", // ✅ Tell elevated process what to do!
	UseShellExecute = true,
	Verb = "runas"
};
```

**3. Changed error messages to use GUI dialogs**

```csharp
// BEFORE (v1.3.3)
Console.Error.WriteLine("Error: Could not determine executable path.");

// AFTER (v1.3.4)
GuiDialogs.ShowError("Could not determine executable path.");
```

### Flow After Fix

```
Double-click HashNow.exe (no args)
	↓
HandleNoArguments() → not admin
	↓
Ask: "Restart as Administrator?"
	↓
User clicks Yes
	↓
RestartAsAdmin() with "--gui-install" argument
	↓
UAC prompt → User clicks Yes
	↓
Elevated HashNow.exe --gui-install starts
	↓
Main() sees "--gui-install" argument
	↓
Calls InstallContextMenuGui()
	↓
Shows success dialog! ✅
```

## Changes Made

### Files Modified

1. **Program.cs**
   - Added `--gui-install` command handler
   - Modified `RestartAsAdmin()` to pass `--gui-install` argument
   - Changed error messages to use `GuiDialogs.ShowError()` instead of `Console.Error.WriteLine()`

2. **Version updates**
   - `HashNow.Cli.csproj`: 1.3.3 → 1.3.4
   - `HashNow.Core.csproj`: 1.3.3 → 1.3.4
   - `FileHasher.cs`: Version constant 1.3.3 → 1.3.4

3. **Documentation**
   - `CHANGELOG.md`: Added v1.3.4 entry
   - `README.md`: Updated download link to v1.3.4

## Testing

### Build & Test Results

```
Build: ✓ Succeeded (0 errors, 1 warning - xUnit1031)
Tests: ✓ 108/108 passed
Publish: ✓ HashNow.exe created
```

### Expected Behavior (v1.3.4)

| Step | Expected Result |
|------|----------------|
| 1. Double-click HashNow.exe | GUI prompt: "Restart as Administrator?" |
| 2. Click Yes | UAC prompt appears |
| 3. Approve UAC | Elevated process starts with `--gui-install` |
| 4. Elevated process runs | Calls `InstallContextMenuGui()` |
| 5. Installation completes | ✅ Success dialog appears! |

## Release

**Version:** v1.3.4  
**Tag:** v1.3.4  
**Commit:** 885c37d  
**Release:** https://github.com/TheAnsarya/HashNow/releases/tag/v1.3.4  
**Download:** HashNow.exe (~52 MB)

### Release Notes

```markdown
### Fixed
- Fixed installation not proceeding when restarting as administrator
- Added --gui-install argument to properly handle UAC elevation
- RestartAsAdmin() now passes argument so elevated process uses GUI dialogs
- Changed error messages to use GUI dialogs instead of console output

### What Was Broken in v1.3.3
When you double-clicked HashNow.exe and it asked for admin privileges:
1. You clicked Yes on the UAC prompt
2. The app restarted as administrator
3. Nothing happened - no installation, no success message, just silence

### The Problem
When the app restarted with admin privileges, it had no arguments, so it went through 
the detection logic again. But this time the parent process was the previous (non-elevated) 
HashNow.exe, not explorer.exe. The elevated process didn't know it should use GUI mode, 
and without arguments telling it what to do, it just exited silently.

### The Solution
Now when restarting as admin, we pass --gui-install argument:
1. Double-click → asks for admin
2. Restart as admin WITH --gui-install argument
3. Elevated process recognizes the argument
4. Runs InstallContextMenuGui()
5. Shows success dialog!
```

## Lessons Learned

1. **UAC Restarts:** When using `UseShellExecute = true` with `Verb = "runas"`, you're starting a **completely new process** - it doesn't inherit arguments
2. **Explicit Communication:** Elevated processes need explicit instructions via arguments
3. **GUI Consistency:** Error messages in GUI mode should always use GUI dialogs, never console
4. **Detection Limitations:** Parent process detection doesn't work across UAC elevation

## Impact

**Severity:** Critical - Installation completely failed after UAC elevation  
**Affected Versions:** v1.3.3 only (v1.3.2 had different issues)  
**Users Impacted:** Anyone who tried to install v1.3.3 and had to elevate  
**Mitigation:** Immediate patch release (v1.3.4)

## Version History - The "WinExe Saga"

- **v1.2.0** - Working CLI/console mode (58→70 algorithms)
- **v1.3.0** - HashFacade refactoring
- **v1.3.1** - Documentation
- **v1.3.2** - Changed to WinExe → broke double-click (console window issue)
- **v1.3.3** - Fixed double-click detection → broke UAC elevation
- **v1.3.4** - Fixed UAC elevation → **finally working!** ✅

## Follow-Up

None required - issue completely resolved in v1.3.4.

## Timeline

- **00:00** - User reports UAC elevation not working
- **00:03** - Root cause identified (no arguments passed to elevated process)
- **00:08** - Fix implemented (--gui-install argument)
- **00:12** - Built, tested, verified
- **00:15** - Released v1.3.4

---

**Session Duration:** ~15 minutes  
**Outcome:** ✅ UAC elevation fix released
